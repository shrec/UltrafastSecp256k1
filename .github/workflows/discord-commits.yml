name: Discord Commit Notifications

on:
  push:
    branches: [main, dev, master]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    steps:
      - name: Notify Discord (push)
        if: ${{ secrets.DISCORD_WEBHOOK_COMMITS != '' }}
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_COMMITS }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          AUTHOR: ${{ github.event.head_commit.author.name }}
          MESSAGE: ${{ github.event.head_commit.message }}
          SHA: ${{ github.sha }}
          COMPARE: ${{ github.event.compare }}
        run: |
          SHORT_SHA="${SHA:0:7}"
          # Escape JSON-special chars in commit message
          SAFE_MSG=$(echo "$MESSAGE" | head -1 | sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g' | head -c 200)
          COMMIT_URL="https://github.com/${REPO}/commit/${SHA}"

          BODY=$(cat <<ENDJSON
          {
            "embeds": [{
              "title": "ðŸ“ New commit on ${BRANCH}",
              "url": "${COMMIT_URL}",
              "color": 7506394,
              "description": "[\`${SHORT_SHA}\`](${COMMIT_URL}) ${SAFE_MSG}",
              "fields": [
                { "name": "Branch", "value": "\`${BRANCH}\`", "inline": true },
                { "name": "Author", "value": "${AUTHOR}", "inline": true }
              ],
              "footer": { "text": "UltrafastSecp256k1" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          ENDJSON
          )

          curl -sS -H "Content-Type: application/json" -d "$BODY" "$WEBHOOK"
