name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly Monday 06:00 UTC — catch new CVEs
    - cron: '0 6 * * 1'

permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Static Analysis: compiler warnings as errors ────────────────────────
  compiler-warnings:
    name: Build with -Werror
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install toolchain
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends g++-13 ninja-build

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DCMAKE_CXX_FLAGS="-Werror -Wall -Wextra -Wpedantic -Wconversion -Wshadow" \
            -DSECP256K1_BUILD_TESTS=ON

      - name: Build (zero warnings required)
        run: cmake --build build -j"$(nproc)"

  # ── Address + Undefined Behavior Sanitizers ─────────────────────────────
  sanitizers:
    name: ASan + UBSan
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install toolchain
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends clang-17 lld-17 ninja-build

      - name: Configure with sanitizers
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-17 \
            -DCMAKE_CXX_COMPILER=clang++-17 \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
            -DSECP256K1_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Test under sanitizers
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
        run: ctest --test-dir build --output-on-failure -j"$(nproc)"

  # ── Valgrind memcheck ───────────────────────────────────────────────────
  valgrind:
    name: Valgrind Memcheck
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install toolchain
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends g++-13 ninja-build valgrind

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DSECP256K1_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Run tests under Valgrind
        run: |
          ctest --test-dir build --output-on-failure -j"$(nproc)" \
            --overwrite MemoryCheckCommand=/usr/bin/valgrind \
            --overwrite "MemoryCheckCommandOptions=--leak-check=full --error-exitcode=1" \
            -T MemCheck || true
          # Check for errors in memcheck output
          if find build/Testing/Temporary -name 'MemoryChecker.*.log' -exec grep -l 'ERROR SUMMARY: [^0]' {} + 2>/dev/null | head -1; then
            echo "::error::Valgrind found memory errors"
            cat build/Testing/Temporary/MemoryChecker.*.log
            exit 1
          fi
