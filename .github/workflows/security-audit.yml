name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly Monday 06:00 UTC — catch new CVEs
    - cron: '0 6 * * 1'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Static Analysis: compiler warnings as errors ────────────────────────
  compiler-warnings:
    name: Build with -Werror
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install toolchain
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends g++-13 ninja-build

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DCMAKE_CXX_FLAGS="-Werror -Wall -Wextra -Wpedantic -Wconversion -Wshadow" \
            -DSECP256K1_BUILD_TESTS=ON

      - name: Build (zero warnings required)
        run: cmake --build build -j"$(nproc)"

  # ── Address + Undefined Behavior Sanitizers ─────────────────────────────
  sanitizers:
    name: ASan + UBSan
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install toolchain
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends clang-17 lld-17 ninja-build

      - name: Configure with sanitizers
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-17 \
            -DCMAKE_CXX_COMPILER=clang++-17 \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
            -DSECP256K1_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Test under sanitizers
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
        # Sanitizers add 3-15x overhead; raise per-test timeout and exclude
        # selftest/unified_audit (standalone tests cover the same modules).
        run: ctest --test-dir build --output-on-failure -j"$(nproc)" -E "^(ct_sidechannel|selftest|unified_audit)" --timeout 900

  # ── Valgrind memcheck ───────────────────────────────────────────────────
  valgrind:
    name: Valgrind Memcheck
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install toolchain
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends g++-13 ninja-build valgrind

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DSECP256K1_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Run tests under Valgrind
        run: |
          ctest --test-dir build --output-on-failure -j"$(nproc)" \
            -E "^ct_sidechannel" \
            --overwrite MemoryCheckCommand=/usr/bin/valgrind \
            --overwrite "MemoryCheckCommandOptions=--leak-check=full --error-exitcode=1 --show-leak-kinds=definite,indirect,possible --errors-for-leak-kinds=definite,indirect,possible --suppressions=${{ github.workspace }}/valgrind.supp" \
            -T MemCheck || true
          # Check for real errors in memcheck output (ignore "still reachable")
          # NB: use -q (quiet) instead of -l | head -1 to preserve exit status
          if grep -q 'ERROR SUMMARY: [1-9]' build/Testing/Temporary/MemoryChecker.*.log 2>/dev/null; then
            echo "::error::Valgrind found memory errors"
            cat build/Testing/Temporary/MemoryChecker.*.log
            exit 1
          fi
          # Also check for definite leaks
          if grep -q 'definitely lost: [1-9]' build/Testing/Temporary/MemoryChecker.*.log 2>/dev/null; then
            echo "::error::Valgrind found definite memory leaks"
            cat build/Testing/Temporary/MemoryChecker.*.log
            exit 1
          fi

  # ── Constant-time side-channel (dudect) smoke test ──────────────────────
  dudect:
    name: dudect Timing Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install toolchain
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends g++-13 ninja-build

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DSECP256K1_BUILD_TESTS=ON

      - name: Build dudect test
        run: cmake --build build --target test_ct_sidechannel_standalone -j"$(nproc)"

      - name: Run dudect timing analysis (5 min timeout)
        run: |
          timeout 300 ./build/cpu/test_ct_sidechannel_standalone 2>&1 | tee dudect_smoke.log || EXIT=$?
          if [ "${EXIT:-0}" -eq 124 ]; then
            echo "::warning::dudect timed out (expected for CI smoke run)"
          elif [ "${EXIT:-0}" -ne 0 ]; then
            echo "::warning::dudect reported timing variance (common on shared CI runners, verify locally)"
          fi
          exit 0

      - name: Upload dudect results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dudect-smoke-results
          path: dudect_smoke.log
          retention-days: 90