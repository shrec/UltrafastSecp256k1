name: SonarCloud

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-24.04

    env:
      BUILD_WRAPPER_OUT_DIR: build-wrapper-output

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0  # Full history for blame / new-code detection

      - name: Install compiler
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y clang-17 lld-17 ninja-build

      - name: Install SonarCloud build-wrapper
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0

      - name: Build with build-wrapper (coverage-instrumented)
        run: |
          export CC=clang-17 CXX=clang++-17
          cmake -S . -B build/sonar -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DSECP256K1_BUILD_TESTS=ON \
            -DSECP256K1_BUILD_BENCH=OFF \
            -DSECP256K1_BUILD_EXAMPLES=OFF \
            -DSECP256K1_USE_ASM=OFF \
            -DCMAKE_C_FLAGS="-fprofile-instr-generate -fcoverage-mapping" \
            -DCMAKE_CXX_FLAGS="-fprofile-instr-generate -fcoverage-mapping"
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUT_DIR }} \
            cmake --build build/sonar -j$(nproc)

      - name: Run tests (generate coverage data)
        run: |
          ctest --test-dir build/sonar --output-on-failure -j$(nproc) -E ct_sidechannel
        env:
          LLVM_PROFILE_FILE: "${{ github.workspace }}/build/sonar/%p.profraw"

      - name: Collect coverage (llvm-cov)
        run: |
          # Find profraw files wherever they ended up
          PROFRAW=$(find build/sonar -name '*.profraw' 2>/dev/null)
          if [ -z "$PROFRAW" ]; then
            echo "::warning::No profraw files found, skipping coverage collection"
            exit 0
          fi
          llvm-profdata-17 merge -sparse $PROFRAW -o build/sonar/merged.profdata
          # Find all test executables for coverage binary list
          BINS=$(find build/sonar -type f -executable ! -name '*.o' ! -path '*/CMakeFiles/*' | head -20)
          FIRST_BIN=$(echo "$BINS" | head -1)
          OBJECT_ARGS=$(echo "$BINS" | tail -n +2 | sed 's/^/-object /')
          llvm-cov-17 show \
            "$FIRST_BIN" $OBJECT_ARGS \
            -instr-profile=build/sonar/merged.profdata \
            --show-line-counts-or-regions \
            > build/sonar/llvm-cov-report.txt 2>/dev/null || true

      - name: Run SonarCloud scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.cfamily.compile-commands=${{ env.BUILD_WRAPPER_OUT_DIR }}/compile_commands.json
            -Dsonar.host.url=https://sonarcloud.io
